{% extends 'base/layout.html' %}
{% block javascripts %}
    {% if preview %}
        <script src="{{ STATIC_URL }}js/preview.js" type="text/javascript" charset="utf-8"></script>
    {% endif %}
    {% if printable %}
        <script src="{{ STATIC_URL }}js/printable.js" type="text/javascript" charset="utf-8"></script>
    {% endif %}
{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/wizzard.css" type="text/css" media="all">
    {% if preview %}
        <link rel="stylesheet" href="{{ STATIC_URL }}css/preview.css" type="text/css" media="all">
    {% endif %}
    {% if printable %}
        <link rel="stylesheet" href="{{ STATIC_URL }}css/print.css" type="text/css" media="all">
    {% endif %}
{% endblock %}
{% block content %}
{% load questionnaire_entry_tags %}

    <div class="section-buttons">
        {% if preview %}
            <a href="{% url 'questionnaire_entry_page' questionnaire.id section.id %}" class="btn btn-default pull-right button-section" id="exit-preview-questionnaire"><span class="glyphicon glyphicon-eye-close"></span> Exit Preview </span> </a>
       {% else %}
            <a href="{% url 'questionnaire_entry_page' questionnaire.id section.id %}?preview=1" class="btn btn-default pull-right button-section" id="preview-questionnaire"><span class="glyphicon glyphicon-eye-open"></span> Preview </span> </a>
       {% endif %}
        <a class="btn btn-default pull-right button-section has-spinner" id="export-section"><span class="spinner"><img class="spinner-image" src="/static/img/spinner.gif"></span><span class="cyan"><span class="glyphicon glyphicon-file red"></span> Export Section as PDF </span> </a>
    </div>

    {% include 'questionnaires/entry/section_breadcrumps_wizzard.html' %}
    {% include 'base/modals/_create.html' with a_form=form action=action modal_id="new-section-modal" modal_title="New Section"%}
    <div class="form-content">
    <h3>{{ section.order}}. {{ section.title | safe }}
        {% if perms.auth.can_edit_questionnaire %}
            <a href="" id="new-subsection" class="btn btn-default pull-right" data-toggle="modal" data-target="#new-subsection-modal"><span class="cyan"><span class="glyphicon glyphicon-plus-sign"></span> New Subsection</span></a>
        {% endif %}
    </h3>
    {% include 'base/modals/_create.html' with a_form=subsection_form action=subsection_action modal_id="new-subsection-modal" modal_title="New Subsection" %}
    {% if section.description %}
        <div class="">
           {{ section.description| safe }}
        </div>
    {% endif %}
    <form class="form-horizontal" id="questionnaire_entry" role="form" method="post">
    {% if preview %}
        <input type='hidden' name='preview' id="preview" value={{ preview }} />
    {% endif %}
    {% csrf_token %}
    {% for form_type, form_set in formsets.formsets.items %}
        {{ form_set.management_form }}
    {% endfor %}
    {% for subsection in section.sub_sections.all %}
        <h4>{% if section.has_at_least_two_subsections %}{{ section.order }}.{{ subsection.order }}.{% endif %} {{subsection.title}}</h4>
        {% for group in subsection.parent_question_groups %}
            <div class="question-group indent">
                {% for order in group.question_orders %}
                        {% if order.question.is_first_in_group %}
                            <h5>{% if subsection.has_at_least_two_groups and group.has_at_least_two_questions %}{{ section.order }}{% if section.has_at_least_two_subsections %}.{{ subsection.order }}{% endif %}.{{group.order}}.{% endif %}</h5>
                            {% if order.question.group.name %}
                                <span class="group-name-instructions"><h5>{{order.question.group.name}} </h5>
                                    {% if order.question.group.instructions %}
                                        <a class="indent" data-toggle="popover" data-html="true" data-placement="bottom" data-trigger="hover" data-content="{{ order.question.group.instructions }}"><i class="glyphicon glyphicon-info-sign cyan"></i> instructions</a>
                                    {% endif %}
                                </span>
                            {% endif %}
                        {% endif %}
                        <div class="form-group">
                                <label class="col-sm-6 control-label">
                                    <div class="question-number">
                                        {{ section.order }}{% if section.has_at_least_two_subsections %}.{{ subsection.order }}{% endif %}.{% if subsection.has_at_least_two_groups %}{{group.order}}.{% endif %}{% if group.has_at_least_two_questions %}{{ order.order }}.{% endif %}
                                    </div>
                                    <div class="question-text">
                                        {{ order.question.text }}
                                    </div>
                                </label>
                                <div class="col-sm-5 center-fields">
                                    {% for field in order.question|get_form:formsets %}
                                        {% if field.errors %}
                                           <div class="field-error">
                                        {% endif %}
                                        {{ field }}
                                        {% if field.errors %}
                                           </div>
                                        {% endif %}
                                        {% if order.question.instructions %}
                                            <a class="indent instructions" data-toggle="popover" data-html="true" data-placement="bottom" data-trigger="hover" data-content="{{ order.question.instructions }}" id="question-{{ order.question.id }}-instructions"><i class="glyphicon glyphicon-info-sign cyan"></i> instructions</a>
                                        {% endif %}
                                        {% if field.errors %}
                                            <a class="indent red" data-toggle="popover" data-placement="bottom" data-trigger="hover" data-content="{{ field.errors|striptags }}" id="question-{{ order.question.id }}-instructions"><i class="glyphicon glyphicon-warning-sign red"></i></a>
                                        {% endif %}
                                    {% endfor %}

                                </div>
                        </div>
                        {% if order.question.group.parent and order.question.is_last_in_group %}
                            <hr/>
                        {% endif %}
               {% endfor %}
            </div>
            {% if group.allow_multiples %}
                <button type="button" href="#" class="btn btn-default add-more"> <span class="cyan bold"><i class="glyphicon glyphicon-plus"></i> Add More</span></button>
            {% endif %}
            <hr class="group-hr"/>
        {% endfor %}
    {% endfor %}
    </div>
    <input type=hidden id="redirect_url" name="redirect_url" />
    <div class="form-group top-padding">
    <div class="col-sm-offset-2 col-sm-4 pull-right">
      <a href="{% url 'home_page' %}" class="btn btn-default" name="cancel_button" id="cancel_button"> <span class="red bold"><i class="glyphicon glyphicon-remove"></i> CANCEL</span></a>
      <button type="submit" class="btn btn-default" id="save_draft_button" name="save_draft"><span class="cyan bold"><i class="glyphicon glyphicon-floppy-disk"></i> SAVE</span></button>
      <button class="btn btn-default" id="submit_modal_button" data-toggle="modal" data-target="#submit_modal"><span class="green bold"><i class="glyphicon glyphicon-ok"></i> SUBMIT</span></button>
    </div>

    <!-- Confirm submission modal -->
    <div class="modal fade" id="submit_modal" tabindex="-1" role="dialog" aria-labelledby="submit_modal_label" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title cyan" id="submit_modal_label">Confirm Submission</h4>
          </div>
          <div class="modal-body">
            <span class="red bold">Confirm:</span> Are you sure you want to submit responses? Any changes after submitting will create another version of the responses.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-default" id="submit_button" name="final_submit"><span class="green bold"><i class="glyphicon glyphicon-ok"></i> SUBMIT</span></button>
          </div>
        </div>
      </div>
    </div>

  </div>

</form>

{% endblock %}

